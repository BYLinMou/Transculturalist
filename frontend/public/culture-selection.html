<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>文化探索 — 選擇主題</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: {
              300: '#ffd700',
              400: '#ffed4e',
              600: '#daa520',
              700: '#b8860b'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/assets/gold-theme.css">
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/i18n.js"></script>
  <script src="/assets/auth.js"></script>
  <script src="/assets/auth-modal.js"></script>
  <script src="/assets/login-prompt.js"></script>
  <script src="/assets/api-helper.js"></script>
  <script src="/assets/load-header.js"></script>
  <style>
    .tag-button {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .tag-button:hover {
      transform: scale(1.05);
    }
    .tag-button.active {
      background-color: rgb(218, 165, 32);
      color: #000;
    }
    .tag-button.inactive {
      background-color: rgba(218, 165, 32, 0.2);
      color: rgb(209, 213, 219);
    }
    .culture-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1.5px solid rgb(55, 65, 81);
    }
    .culture-card:hover {
      transform: translateY(-8px);
      border-color: rgb(218, 165, 32);
      box-shadow: 0 20px 40px rgba(218, 165, 32, 0.2);
    }
    .culture-card.hidden {
      display: none;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- Header -->
  <header></header>

  <main class="container mx-auto px-6 py-8">
    <!-- Title Section -->
    <div class="text-center mb-10">
      <h2 class="text-display font-bold mb-3 text-gold-300" data-i18n="selectCulture">選擇您感興趣的文化主題</h2>
      <p class="text-body-lg text-gray-400" data-i18n="exploreCultures">探索不同文化，通過遊戲學習知識</p>
    </div>

    <!-- Tags Filter Section -->
    <div class="mb-10 flex flex-wrap gap-3 justify-center" id="tagsContainer">
      <!-- Tag buttons will be rendered here by JavaScript -->
    </div>

    <!-- Cultures Grid Container -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="themesGrid">
      <!-- Culture cards will be rendered here by JavaScript -->
    </div>
  </main>

  <script>
    const state = {
      shares: [],
      tags: [],
      currentTag: 'all',
    };

    const selectors = {
      tagsContainer: () => document.getElementById('tagsContainer'),
      themesGrid: () => document.getElementById('themesGrid'),
    };

    async function fetchJson(url) {
      try {
        const response = await fetch(url);
        const result = await response.json();
        return result.success ? result.data : null;
      } catch (error) {
        console.error('API request failed:', error);
        return null;
      }
    }

    async function loadTags() {
      const data = await fetchJson('/api/forum/gettaglist');
      if (!data) {
        selectors.tagsContainer().innerHTML = '<p class="text-gray-400">標籤資料載入失敗</p>';
        return false;
      }

      state.tags = data;
      renderTagButtons();
      return true;
    }

    async function loadShares(tagId = 'all') {
      const baseUrl = '/api/forum/getcardinfo?sort=-created_at&limit=100';
      const url = tagId !== 'all' ? `${baseUrl}&tag_ids=${tagId}` : baseUrl;
      const data = await fetchJson(url);

      if (!data) {
        selectors.themesGrid().innerHTML = '<p class="text-gray-400">分享內容載入失敗</p>';
        return false;
      }

      state.shares = data;
      renderCultureCards();
      return true;
    }

    function createTagButton({ id, name }) {
      const button = document.createElement('button');
      button.className = 'tag-button inactive px-4 py-2 rounded-full text-body-sm font-medium border border-gray-600';
      button.dataset.tag = id;
      button.textContent = name;
      button.addEventListener('click', () => handleTagSelection(id));
      return button;
    }

    function renderTagButtons() {
      const container = selectors.tagsContainer();
      const fragment = document.createDocumentFragment();

      const allButton = document.createElement('button');
      allButton.className = 'tag-button px-4 py-2 rounded-full text-body-sm font-medium border';
      allButton.dataset.tag = 'all';
      allButton.textContent = '全部';
      allButton.addEventListener('click', () => handleTagSelection('all'));
      fragment.appendChild(allButton);

      state.tags.forEach(tag => fragment.appendChild(createTagButton(tag)));

      container.innerHTML = '';
      container.appendChild(fragment);
      updateActiveTagButton(state.currentTag);
    }

    function updateActiveTagButton(tagId) {
      document.querySelectorAll('.tag-button').forEach(button => {
        const isActive = button.dataset.tag === String(tagId);
        button.classList.toggle('active', isActive);
        button.classList.toggle('inactive', !isActive);
        button.style.borderColor = isActive ? 'rgb(218, 165, 32)' : 'rgb(75, 85, 99)';
      });
    }

    function transformShareToCard(share) {
      const tags = Array.isArray(share.tags) ? share.tags : [];
      return {
        id: share.id,
        emoji: share.icon || '🌟',
        title: share.title,
        description: share.description,
        tags: tags.map(tag => tag.id),
        tagNames: tags.map(tag => tag.name),
        shareId: share.id,
        viewCount: share.view_count || 0,
        likeCount: share.like_count || 0,
      };
    }

    function renderCultureCards() {
      const container = selectors.themesGrid();
      container.innerHTML = '';

      const fragment = document.createDocumentFragment();

      state.shares.forEach(rawShare => {
        const share = transformShareToCard(rawShare);
        const card = document.createElement('div');
        card.className = 'culture-card bg-gray-900 bg-opacity-70 p-8 rounded-lg';
        card.dataset.shareId = share.shareId;
        card.dataset.tags = share.tags.join(',');

        const tagsHTML = share.tagNames
          .map(name => `<span class="inline-block bg-gray-800 text-gold-300 px-3 py-1 rounded-full text-caption font-medium">${name}</span>`)
          .join('');

        card.innerHTML = `
          <div class="text-center">
            <div class="emoji-lg mb-4">${share.emoji}</div>
            <h3 class="text-title font-bold text-gold-300 mb-2">${share.title}</h3>
            <p class="text-body-sm text-gray-400 mb-4">${share.description}</p>
            <div class="flex flex-wrap gap-2 justify-center">
              ${tagsHTML}
            </div>
            <div class="text-caption text-gray-500 mt-4">
              👁️ ${share.viewCount} | ❤️ ${share.likeCount}
            </div>
          </div>
        `;

        card.addEventListener('click', () => {
          localStorage.setItem('selectedShareId', share.shareId);
          console.debug('Share selected:', share.shareId);
        });

        fragment.appendChild(card);
      });

      container.appendChild(fragment);
    }

    async function handleTagSelection(tagId) {
      if (state.currentTag === tagId) {
        return;
      }

      state.currentTag = tagId;
      updateActiveTagButton(tagId);
      await loadShares(tagId);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const tagsLoaded = await loadTags();
      if (!tagsLoaded) {
        return;
      }

      await loadShares(state.currentTag);
    });
  </script>
</body>
</html>
