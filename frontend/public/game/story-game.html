<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文化探索 — 故事探索</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: {
              300: '#ffd700',
              400: '#ffed4e',
              600: '#daa520',
              700: '#b8860b'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/i18n.js"></script>
  <script src="/assets/api-helper.js"></script>
  <script src="/assets/error-display.js"></script>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- Header placeholder -->
  <header></header>

  <div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-8">
      <button id="backToGames" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="text-center">
        <h2 class="text-2xl font-bold text-gold-300" data-i18n="storyExploration">互動式故事探索</h2>
        <p class="text-gray-400" id="currentTheme"></p>
      </div>
      <div class="text-right">
        <div class="text-gold-300 font-bold"><span data-i18n="chapter">章節</span>: <span id="chapterNum">1</span></div>
      </div>
    </div>

    <div id="loadingContainer" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gold-400 mb-4"></div>
      <p class="text-gray-300" data-i18n="generatingStory">正在生成故事...</p>
    </div>

    <div id="storyContainer" class="hidden">
      <div class="bg-gray-900 bg-opacity-80 p-8 rounded-xl border border-gray-700 mb-6">
        <h3 class="text-2xl font-bold text-gold-300 mb-4" id="storyTitle">載入中...</h3>
        <div class="text-gray-100 leading-relaxed whitespace-pre-wrap mb-6" id="storyContent"></div>
        
        <div class="border-t border-gray-700 pt-6">
          <h4 class="text-lg font-semibold text-gold-400 mb-4" data-i18n="chooseAction">選擇你的行動：</h4>
          <div id="choicesContainer" class="space-y-3"></div>
        </div>
      </div>

      <div class="text-center">
        <button id="restartStory" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors" data-i18n="restartStory">
          重新開始故事
        </button>
      </div>
    </div>
  </div>

  <script src="/assets/load-header.js"></script>
  <script>
    // Get theme from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentTheme = urlParams.get('theme') || '中華文化';
    
    let chapterNumber = 1;
    let storyHistory = [];

    document.getElementById('currentTheme').textContent = currentTheme;

    // Generate story chapter from server API with language support
    async function generateChapter(previousChoice = null) {
      document.getElementById('loadingContainer').classList.remove('hidden');
      document.getElementById('storyContainer').classList.add('hidden');
      
      try {
        const response = await window.apiHelper.request('/api/story/chapter', {
          method: 'POST',
          body: JSON.stringify({
            theme: currentTheme,
            chapterNumber: chapterNumber,
            previousChoice: previousChoice
          })
        });

        const result = await response.json();
        
        if (result.success && result.data) {
          displayChapter(result.data);
        } else {
          throw new Error('Failed to generate story chapter');
        }
      } catch (error) {
        console.error('Error generating chapter:', error);
        const generateFailedText = window.errorDisplay.getTranslatedText('generateStoryFailed', '生成故事失敗');
        window.errorDisplay.showInlineError(
          document.getElementById('loadingContainer'),
          generateFailedText,
          { retryAction: () => location.reload() }
        );
      }
    }

    function displayChapter(chapterData) {
      document.getElementById('loadingContainer').classList.add('hidden');
      document.getElementById('storyContainer').classList.remove('hidden');
      
      document.getElementById('chapterNum').textContent = chapterNumber;
      document.getElementById('storyTitle').textContent = chapterData.title || `第 ${chapterNumber} 章`;
      document.getElementById('storyContent').textContent = chapterData.content || '';
      
      // Display choices
      const choicesContainer = document.getElementById('choicesContainer');
      choicesContainer.innerHTML = '';
      
      if (chapterData.choices && chapterData.choices.length > 0) {
        chapterData.choices.forEach((choice, index) => {
          const button = document.createElement('button');
          button.className = 'w-full text-left p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors border border-gray-600 group';
          
          const choiceText = document.createElement('div');
          choiceText.className = 'font-semibold text-gold-300 mb-1 group-hover:text-gold-400';
          choiceText.textContent = choice.text || `選項 ${index + 1}`;
          
          const choiceDesc = document.createElement('div');
          choiceDesc.className = 'text-sm text-gray-400';
          choiceDesc.textContent = choice.description || '';
          
          button.appendChild(choiceText);
          if (choice.description) {
            button.appendChild(choiceDesc);
          }
          
          button.onclick = () => makeChoice(choice.text);
          choicesContainer.appendChild(button);
        });
      } else {
        // Story ended
        const endMessage = document.createElement('div');
        endMessage.className = 'text-center p-6 bg-gray-800 rounded-lg border border-gold-600';
        const storyEndedText = window.i18next ? window.i18next.t('storyEnded') : '故事結束';
        const thankYouText = window.i18next ? window.i18next.t('thankYou') : '感謝你的參與！';
        endMessage.innerHTML = `
          <p class="text-xl text-gold-300 font-bold mb-2">${storyEndedText}</p>
          <p class="text-gray-400">${thankYouText}</p>
        `;
        choicesContainer.appendChild(endMessage);
      }
    }

    function makeChoice(choiceText) {
      storyHistory.push({
        chapter: chapterNumber,
        choice: choiceText
      });
      
      chapterNumber++;
      generateChapter(choiceText);
    }

    function restartStory() {
      chapterNumber = 1;
      storyHistory = [];
      generateChapter();
    }

    // Event listeners
    document.getElementById('backToGames').addEventListener('click', () => {
      window.location.href = '/game/game-selection.html';
    });

    document.getElementById('restartStory').addEventListener('click', restartStory);

    // Start game
    generateChapter();
  </script>
</body>
</html>
