<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文化探索 — 問答遊戲</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: {
              300: '#ffd700',
              400: '#ffed4e',
              600: '#daa520',
              700: '#b8860b'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/assets/gold-theme.css">
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/config.js"></script>
  <script src="/assets/i18n.js"></script>
  <script src="/assets/auth.js"></script>
  <script src="/assets/auth-modal.js"></script>
  <script src="/assets/login-prompt.js"></script>
  <script src="/assets/api-helper.js"></script>
  <script src="/assets/error-display.js"></script>
  <script src="/assets/guest-game-storage.js"></script>
  <script src="/assets/load-header.js"></script>
  <script src="/assets/timer.js"></script>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- Header placeholder -->
  <header></header>


  <div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-8">
      <button id="backToGames" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="text-center">
        <h2 class="text-title-lg font-bold text-gold-300" data-i18n="culturalQuiz">文化問答</h2>
        <p class="text-gray-400 text-body-sm" id="currentTheme"></p>
      </div>
      <div class="text-right">
        <div class="text-gold-300 font-bold text-body"><span data-i18n="timer">計時</span>: <span id="timer">00:00</span></div>
        <div class="text-gold-300 font-bold text-body"><span data-i18n="score">分數</span>: <span id="score">0</span></div>
        <div class="text-gray-400 text-body-sm"><span data-i18n="question">題目</span>: <span id="questionNum">1</span>/5</div>
      </div>
    </div>
    
    <div class="bg-gray-900 bg-opacity-80 p-8 rounded-xl border border-gray-700">
      <div id="loadingContainer" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gold-400 mb-4"></div>
        <p class="text-gray-300 text-body" data-i18n="generatingQuestions">正在生成題目...</p>
      </div>

      <div id="questionContainer" class="hidden">
        <h3 class="text-title font-semibold mb-6 text-white" id="questionText"></h3>
        <div id="optionsContainer" class="space-y-3"></div>
      </div>
      
      <div id="resultContainer" class="hidden text-center">
        <h3 class="text-title-lg font-bold mb-4 text-gold-300" data-i18n="gameOver">遊戲結束！</h3>
        <p class="text-title-sm mb-6"><span data-i18n="yourFinalScore">你的最終分數</span>: <span id="finalScore" class="text-gold-400 font-bold">0</span>/5</p>
        <div class="flex gap-4 justify-center">
          <button id="finishGameBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors text-body" data-i18n="finishGame">
            完成遊戲
          </button>
          <button id="restartMCQ" class="px-6 py-3 gold-gradient text-black font-bold rounded-lg hover:opacity-90 transition-opacity text-body" data-i18n="restart">重新開始</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get theme from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentTheme = urlParams.get('theme') || '中華文化';
    
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let answered = false;
    let gameTimer = null;

    document.getElementById('currentTheme').textContent = currentTheme;

    // Load questions from server API with language support
    async function loadQuestions() {
      document.getElementById('loadingContainer').classList.remove('hidden');
      document.getElementById('questionContainer').classList.add('hidden');
      
      try {
        const response = await window.apiHelper.request('/api/ai/generate', {
          method: 'POST',
          body: JSON.stringify({
            gameId: 'mcq',
            theme: currentTheme,
            params: { numQuestions: 5 }
          })
        });

        const result = await response.json();
        
        if (result.success && result.data && result.data.questions) {
          questions = result.data.questions;
          document.getElementById('loadingContainer').classList.add('hidden');
          startTimer();
          loadQuestion();
        } else {
          throw new Error('Failed to generate questions');
        }
      } catch (error) {
        console.error('Error loading questions:', error);
        const loadFailedText = window.errorDisplay.getTranslatedText('loadFailed', '載入題目失敗');
        window.errorDisplay.showInlineError(
          document.getElementById('loadingContainer'),
          loadFailedText,
          { retryAction: () => location.reload() }
        );
      }
    }

    function loadQuestion() {
      if (currentQuestionIndex >= questions.length) {
        showResult();
        return;
      }

      answered = false;
      document.getElementById('questionContainer').classList.remove('hidden');
      
      const question = questions[currentQuestionIndex];
      document.getElementById('questionText').textContent = question.question;
      document.getElementById('questionNum').textContent = currentQuestionIndex + 1;

      const optionsContainer = document.getElementById('optionsContainer');
      optionsContainer.innerHTML = '';

      question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'w-full text-left p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors border border-gray-600';
        button.textContent = option;
        button.onclick = () => selectAnswer(index, button);
        optionsContainer.appendChild(button);
      });
    }

    function selectAnswer(selectedIndex, button) {
      if (answered) return;
      answered = true;

      const question = questions[currentQuestionIndex];
      const isCorrect = selectedIndex === question.correct;

      if (isCorrect) {
        score++;
        button.classList.add('bg-green-600', 'border-green-400');
        document.getElementById('score').textContent = score;
      } else {
        button.classList.add('bg-red-600', 'border-red-400');
        // Highlight correct answer
        const buttons = document.getElementById('optionsContainer').querySelectorAll('button');
        buttons[question.correct].classList.add('bg-green-600', 'border-green-400');
      }

      // Disable all buttons
      const allButtons = document.getElementById('optionsContainer').querySelectorAll('button');
      allButtons.forEach(btn => btn.disabled = true);

      // Move to next question after delay
      setTimeout(() => {
        currentQuestionIndex++;
        loadQuestion();
      }, 2000);
    }

    function showResult() {
      if (gameTimer) {
        gameTimer.pause();
      }
      document.getElementById('questionContainer').classList.add('hidden');
      document.getElementById('resultContainer').classList.remove('hidden');
      document.getElementById('finalScore').textContent = score;
      
      // Auto-save game result when all questions answered (completed=true)
      autoSaveGameResult();
    }

    // Auto-save game result when user completes all questions
    async function autoSaveGameResult() {
      if (gameTimer) {
        const result = await gameTimer.finishGame({
          score: score,
          accuracy: score / (questions.length > 0 ? questions.length : 1),
          completed: true  // All questions answered, game is completed
        });
        
        console.log('[MCQ] Game auto-saved with result:', result);
      }
    }

    // Handle finishing game (user clicks finish button to go back)
    async function finishGame() {
      // Game result already auto-saved when all questions answered
      // Just show success message and navigate back
      alert(window.i18next ? window.i18next.t('gameSaved') : '遊戲已保存！');
      
      if (gameTimer) {
        gameTimer.destroy();
      }
      window.location.href = '/game/game-selection.html';
    }

    function restartGame() {
      if (gameTimer) {
        gameTimer.reset();
      }
      currentQuestionIndex = 0;
      score = 0;
      document.getElementById('score').textContent = score;
      document.getElementById('resultContainer').classList.add('hidden');
      loadQuestions();
    }

    // Event listeners
    document.getElementById('backToGames').addEventListener('click', () => {
      if (gameTimer) {
        // Save game progress when returning
        gameTimer.finishGame({
          score: score,
          accuracy: score / (questions.length > 0 ? questions.length : 1),
          completed: false
        }).then(() => {
          gameTimer.destroy();
          window.location.href = '/game/game-selection.html';
        }).catch(() => {
          // Even if save fails, still navigate
          gameTimer.destroy();
          window.location.href = '/game/game-selection.html';
        });
      } else {
        window.location.href = '/game/game-selection.html';
      }
    });

    document.getElementById('finishGameBtn').addEventListener('click', finishGame);
    document.getElementById('restartMCQ').addEventListener('click', restartGame);

    // Add timer display support and startup
    function startTimer() {
      if (!gameTimer) {
        gameTimer = new window.GameTimer({
          displayElement: document.getElementById('timer') || null,
          gameName: 'mcq',
          theme: currentTheme,
          syncIntervalSeconds: window.GameConfig.get('TIMER.AUTO_SYNC_INTERVAL', 10)
        });
      }
      gameTimer.start();
    }

    // Start game
    loadQuestions();
  </script>
</body>
</html>
