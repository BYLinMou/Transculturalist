<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文化探索 — 角色扮演</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: {
              300: '#ffd700',
              400: '#ffed4e',
              600: '#daa520',
              700: '#b8860b'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/assets/gold-theme.css">
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/config.js"></script>
  <script src="/assets/i18n.js"></script>
  <script src="/assets/auth.js"></script>
  <script src="/assets/auth-modal.js"></script>
  <script src="/assets/login-prompt.js"></script>
  <script src="/assets/api-helper.js"></script>
  <script src="/assets/error-display.js"></script>
  <script src="/assets/guest-game-storage.js"></script>
  <script src="/assets/load-header.js"></script>
  <script src="/assets/timer.js"></script>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- Header placeholder -->
  <header></header>

  <div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-8">
      <button id="backToGames" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="text-center">
        <h2 class="text-title-lg font-bold text-gold-300 flex items-center justify-center gap-2">
          <span data-i18n="roleplayInteraction">角色扮演互動</span>
          <div class="group relative inline-block">
            <span class="text-gold-400 text-lg cursor-help font-bold">ⓘ</span>
            <div class="absolute left-1/2 top-full transform -translate-x-1/2 mt-2 px-3 py-2 bg-gray-800 text-white text-xs rounded whitespace-nowrap hidden group-hover:block border border-gold-600 z-50 pointer-events-none">
              <div data-i18n="roleplayScoreFormula">分數即聊天回合數，滿分為5。</div>
              <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-full border-4 border-transparent border-b-gray-800"></div>
            </div>
          </div>
        </h2>
        <p class="text-gray-400 text-body-sm" id="currentTheme"></p>
      </div>
      <div class="flex gap-4">
        <div class="text-gold-300 font-bold text-body"><span data-i18n="timer">計時</span>: <span id="timer">00:00</span></div>
        <button id="newCharacter" class="px-4 py-2 bg-gold-600 hover:bg-gold-700 text-black font-semibold rounded-lg transition-colors text-body-sm" data-i18n="changeCharacter">
          換個角色
        </button>
      </div>
    </div>

    <div id="loadingContainer" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gold-400 mb-4"></div>
      <p class="text-gray-300 text-body" data-i18n="generatingCharacter">正在生成角色...</p>
    </div>

    <div id="gameContainer" class="hidden">
      <!-- Character card -->
      <div class="bg-gray-900 bg-opacity-80 p-6 rounded-xl border border-gray-700 mb-6">
        <div class="flex items-start gap-4">
          <div class="emoji-lg" id="characterEmoji">👤</div>
          <div class="flex-1">
            <h3 class="text-title-lg font-bold text-gold-300 mb-2" id="characterName">載入中...</h3>
            <p class="text-gray-300 mb-2 text-body" id="characterDescription"></p>
            <div class="text-body-sm text-gray-400">
              <p><span class="text-gold-400" data-i18n="personality">性格：</span><span id="characterPersonality"></span></p>
              <p><span class="text-gold-400" data-i18n="expertise">專長：</span><span id="characterKnowledge"></span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat container -->
      <div class="bg-gray-900 bg-opacity-80 rounded-xl border border-gray-700 mb-4">
        <div id="chatMessages" class="p-6 space-y-4 max-h-96 overflow-y-auto"></div>
      </div>

      <!-- Input area -->
      <div class="flex gap-3">
        <input 
          type="text" 
          id="userMessage" 
          data-i18n-placeholder="inputMessage"
          placeholder="輸入你的訊息..." 
          class="flex-1 p-4 bg-gray-800 text-white rounded-lg border border-gray-600 focus:border-gold-500 focus:outline-none text-body"
        />
        <button 
          id="sendMessage" 
          class="px-6 py-4 gold-gradient text-black font-bold rounded-lg hover:opacity-90 transition-opacity text-body"
          data-i18n="send"
        >
          發送
        </button>
      </div>
    </div>
  </div>

  <script src="/assets/load-header.js"></script>
  <script>
    // Get theme from URL or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const shareId = urlParams.get('shareId') || localStorage.getItem('selectedShareId');
    const currentTheme = localStorage.getItem('selectedTheme') || '中華文化';
    const currentDescription = localStorage.getItem('selectedDescription') || '';
    
    let currentCharacter = null;
    let conversationHistory = []; // Array of { role: 'user' | 'assistant', content: 'message' }
    let maxHistoryPairs = 5; // Default: 5 pairs (5 user + 5 assistant = 10 messages), will be updated from server config
    let gameTimer = null;

    document.getElementById('currentTheme').textContent = currentTheme;

    // Generate character from server API with language support
    async function generateCharacter() {
      document.getElementById('loadingContainer').classList.remove('hidden');
      document.getElementById('gameContainer').classList.add('hidden');
      
      try {
        const response = await window.apiHelper.request('/api/roleplay/character', {
          method: 'POST',
          body: JSON.stringify({ 
            theme: currentTheme,
            description: currentDescription,
            shareId: shareId
          })
        });

        const result = await response.json();
        
        if (result.success && result.data) {
          currentCharacter = result.data;
          
          // Update maxHistoryPairs from server config
          if (result.maxHistory !== undefined) {
            maxHistoryPairs = result.maxHistory; // This represents X pairs (X user + X assistant = 2X messages)
            console.log(`Chat history limit set to ${maxHistoryPairs} pairs (${maxHistoryPairs * 2} messages total)`);
          }
          
          setupCharacter(currentCharacter);
          startTimer();
        } else {
          throw new Error('Failed to generate character');
        }
      } catch (error) {
        console.error('Error generating character:', error);
        const generateFailedText = window.errorDisplay.getTranslatedText('generateCharacterFailed', '生成角色失敗');
        window.errorDisplay.showInlineError(
          document.getElementById('loadingContainer'),
          generateFailedText,
          { retryAction: () => location.reload() }
        );
      }
    }

    function setupCharacter(character) {
      document.getElementById('loadingContainer').classList.add('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      
      document.getElementById('characterEmoji').textContent = character.emoji || '👤';
      document.getElementById('characterName').textContent = character.name || '角色';
      document.getElementById('characterDescription').textContent = character.description || '';
      document.getElementById('characterPersonality').textContent = character.personality || '';
      document.getElementById('characterKnowledge').textContent = character.knowledge || '';
      
      // Clear chat and add greeting
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      conversationHistory = [];
      
      // Add greeting message to UI
      const greetingText = character.greeting || '你好！很高興與你交流。';
      addMessage('character', greetingText, character.name);
      
      // Add greeting to conversation history so it's included in future context
      conversationHistory.push({ role: 'assistant', content: greetingText });
    }

    function addMessage(sender, content, name = '') {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
      
      const bubble = document.createElement('div');
      bubble.className = `max-w-[70%] p-4 rounded-lg ${
        sender === 'user' 
          ? 'bg-gold-600 text-black' 
          : 'bg-gray-800 text-white border border-gray-600'
      }`;
      
      if (sender === 'character') {
        const nameSpan = document.createElement('div');
        nameSpan.className = 'text-sm text-gold-400 font-semibold mb-1';
        nameSpan.textContent = name;
        bubble.appendChild(nameSpan);
      }
      
      const contentDiv = document.createElement('div');
      contentDiv.textContent = content;
      bubble.appendChild(contentDiv);
      
      messageDiv.appendChild(bubble);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addLoadingMessage() {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex justify-start';
      messageDiv.id = 'loadingMessage';
      
      const bubble = document.createElement('div');
      bubble.className = 'max-w-[70%] p-4 rounded-lg bg-gray-800 text-white border border-gray-600';
      bubble.innerHTML = '<div class="flex gap-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div></div>';
      
      messageDiv.appendChild(bubble);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeLoadingMessage() {
      const loading = document.getElementById('loadingMessage');
      if (loading) loading.remove();
    }

    async function sendUserMessage() {
      const input = document.getElementById('userMessage');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message to UI
      addMessage('user', message);
      input.value = '';
      input.disabled = true;
      
      // Add user message to history
      conversationHistory.push({ role: 'user', content: message });
      
      // Add loading indicator
      addLoadingMessage();
      
      try {
        const response = await window.apiHelper.request('/api/roleplay/chat', {
          method: 'POST',
          body: JSON.stringify({
            theme: currentTheme,
            description: currentDescription,
            shareId: shareId,
            character: currentCharacter,
            userMessage: message,
            history: conversationHistory.slice(-maxHistoryPairs * 2) // Keep last X pairs (2X messages)
          })
        });

        const result = await response.json();
        
        removeLoadingMessage();
        
        if (result.success && result.data && result.data.response) {
          const assistantMessage = result.data.response;
          addMessage('character', assistantMessage, currentCharacter.name);
          
          // Add assistant message to history
          conversationHistory.push({ role: 'assistant', content: assistantMessage });
          
          // Trim history to keep only last X pairs (2X messages total)
          if (conversationHistory.length > maxHistoryPairs * 2) {
            conversationHistory = conversationHistory.slice(-maxHistoryPairs * 2);
          }
        } else {
          throw new Error('Failed to get response');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        removeLoadingMessage();
        const responseFailedText = window.errorDisplay.getTranslatedText('characterResponseFailed', '抱歉，我現在無法回應。請稍後再試。');
        addMessage('character', responseFailedText, currentCharacter.name);
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    // Event listeners
    document.getElementById('backToGames').addEventListener('click', () => {
      if (gameTimer) {
  // For roleplay, any exit counts as completion if user has replied
  const userTurns = conversationHistory.filter(msg => msg.role === 'user').length;
  const isCompleted = userTurns > 0;
  // Score is user turns, max 5
  const score = Math.min(userTurns, 5);
        gameTimer.finishGame({
          score: score,
          accuracy: 0.5, // Roleplay doesn't have accuracy
          completed: isCompleted  // Completed if there was any conversation
        }).then(() => {
          gameTimer.destroy();
          window.location.href = '/game/game-selection.html';
        }).catch(() => {
          // Even if save fails, still navigate
          gameTimer.destroy();
          window.location.href = '/game/game-selection.html';
        });
      } else {
        window.location.href = '/game/game-selection.html';
      }
    });

    document.getElementById('newCharacter').addEventListener('click', () => {
      if (gameTimer) {
  // Switching character counts as completing the current character session
  const userTurns = conversationHistory.filter(msg => msg.role === 'user').length;
  const isCompleted = userTurns > 0;
  // Score is user turns, max 5
  const score = Math.min(userTurns, 5);
        gameTimer.finishGame({
          score: score,
          accuracy: 0.5,
          completed: isCompleted  // Completed if there was any conversation
        }).then(() => {
          // Reset for new character
          gameTimer.reset();
          conversationHistory = [];
          generateCharacter();
        }).catch(() => {
          // Even if save fails, still proceed with new character
          gameTimer.reset();
          conversationHistory = [];
          generateCharacter();
        });
      } else {
        conversationHistory = [];
        generateCharacter();
      }
    });
    
    document.getElementById('sendMessage').addEventListener('click', sendUserMessage);
    
    document.getElementById('userMessage').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
      }
    });

    // Timer initialization
    function startTimer() {
      if (!gameTimer) {
        gameTimer = new window.GameTimer({
          displayElement: document.getElementById('timer'),
          gameName: 'roleplay',
          theme: currentTheme,
          syncIntervalSeconds: window.GameConfig.get('TIMER.AUTO_SYNC_INTERVAL', 10)
        });
      }
      gameTimer.start();
    }

    // Start game
    generateCharacter();
  </script>
</body>
</html>
