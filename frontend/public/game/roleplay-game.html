<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文化探索 — 角色扮演</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: {
              300: '#ffd700',
              400: '#ffed4e',
              600: '#daa520',
              700: '#b8860b'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/i18n.js"></script>
  <script src="/assets/api-helper.js"></script>
  <script src="/assets/error-display.js"></script>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- Header placeholder -->
  <header></header>

  <div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-8">
      <button id="backToGames" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="text-center">
        <h2 class="text-2xl font-bold text-gold-300" data-i18n="roleplayInteraction">角色扮演互動</h2>
        <p class="text-gray-400" id="currentTheme"></p>
      </div>
      <div>
        <button id="newCharacter" class="px-4 py-2 bg-gold-600 hover:bg-gold-700 text-black font-semibold rounded-lg transition-colors" data-i18n="changeCharacter">
          換個角色
        </button>
      </div>
    </div>

    <div id="loadingContainer" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gold-400 mb-4"></div>
      <p class="text-gray-300" data-i18n="generatingCharacter">正在生成角色...</p>
    </div>

    <div id="gameContainer" class="hidden">
      <!-- Character card -->
      <div class="bg-gray-900 bg-opacity-80 p-6 rounded-xl border border-gray-700 mb-6">
        <div class="flex items-start gap-4">
          <div class="text-5xl" id="characterEmoji">👤</div>
          <div class="flex-1">
            <h3 class="text-2xl font-bold text-gold-300 mb-2" id="characterName">載入中...</h3>
            <p class="text-gray-300 mb-2" id="characterDescription"></p>
            <div class="text-sm text-gray-400">
              <p><span class="text-gold-400" data-i18n="personality">性格：</span><span id="characterPersonality"></span></p>
              <p><span class="text-gold-400" data-i18n="expertise">專長：</span><span id="characterKnowledge"></span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat container -->
      <div class="bg-gray-900 bg-opacity-80 rounded-xl border border-gray-700 mb-4">
        <div id="chatMessages" class="p-6 space-y-4 max-h-96 overflow-y-auto"></div>
      </div>

      <!-- Input area -->
      <div class="flex gap-3">
        <input 
          type="text" 
          id="userMessage" 
          data-i18n-placeholder="inputMessage"
          placeholder="輸入你的訊息..." 
          class="flex-1 p-4 bg-gray-800 text-white rounded-lg border border-gray-600 focus:border-gold-500 focus:outline-none"
        />
        <button 
          id="sendMessage" 
          class="px-6 py-4 gold-gradient text-black font-bold rounded-lg hover:opacity-90 transition-opacity"
          data-i18n="send"
        >
          發送
        </button>
      </div>
    </div>
  </div>

  <script src="/assets/load-header.js"></script>
  <script>
    // Get theme from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentTheme = urlParams.get('theme') || '中華文化';
    
    let currentCharacter = null;
    let conversationHistory = [];

    document.getElementById('currentTheme').textContent = currentTheme;

    // Generate character from server API with language support
    async function generateCharacter() {
      document.getElementById('loadingContainer').classList.remove('hidden');
      document.getElementById('gameContainer').classList.add('hidden');
      
      try {
        const response = await window.apiHelper.request('/api/roleplay/character', {
          method: 'POST',
          body: JSON.stringify({ theme: currentTheme })
        });

        const result = await response.json();
        
        if (result.success && result.data) {
          currentCharacter = result.data;
          setupCharacter(currentCharacter);
        } else {
          throw new Error('Failed to generate character');
        }
      } catch (error) {
        console.error('Error generating character:', error);
        const generateFailedText = window.errorDisplay.getTranslatedText('generateCharacterFailed', '生成角色失敗');
        window.errorDisplay.showInlineError(
          document.getElementById('loadingContainer'),
          generateFailedText,
          { retryAction: () => location.reload() }
        );
      }
    }

    function setupCharacter(character) {
      document.getElementById('loadingContainer').classList.add('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      
      document.getElementById('characterEmoji').textContent = character.emoji || '👤';
      document.getElementById('characterName').textContent = character.name || '角色';
      document.getElementById('characterDescription').textContent = character.description || '';
      document.getElementById('characterPersonality').textContent = character.personality || '';
      document.getElementById('characterKnowledge').textContent = character.knowledge || '';
      
      // Clear chat and add greeting
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      conversationHistory = [];
      
      addMessage('character', character.greeting || '你好！很高興與你交流。', character.name);
    }

    function addMessage(sender, content, name = '') {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
      
      const bubble = document.createElement('div');
      bubble.className = `max-w-[70%] p-4 rounded-lg ${
        sender === 'user' 
          ? 'bg-gold-600 text-black' 
          : 'bg-gray-800 text-white border border-gray-600'
      }`;
      
      if (sender === 'character') {
        const nameSpan = document.createElement('div');
        nameSpan.className = 'text-sm text-gold-400 font-semibold mb-1';
        nameSpan.textContent = name;
        bubble.appendChild(nameSpan);
      }
      
      const contentDiv = document.createElement('div');
      contentDiv.textContent = content;
      bubble.appendChild(contentDiv);
      
      messageDiv.appendChild(bubble);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addLoadingMessage() {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex justify-start';
      messageDiv.id = 'loadingMessage';
      
      const bubble = document.createElement('div');
      bubble.className = 'max-w-[70%] p-4 rounded-lg bg-gray-800 text-white border border-gray-600';
      bubble.innerHTML = '<div class="flex gap-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div></div>';
      
      messageDiv.appendChild(bubble);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeLoadingMessage() {
      const loading = document.getElementById('loadingMessage');
      if (loading) loading.remove();
    }

    async function sendUserMessage() {
      const input = document.getElementById('userMessage');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      addMessage('user', message);
      input.value = '';
      input.disabled = true;
      
      // Add loading indicator
      addLoadingMessage();
      
      try {
        const response = await window.apiHelper.request('/api/roleplay/chat', {
          method: 'POST',
          body: JSON.stringify({
            theme: currentTheme,
            character: currentCharacter,
            userMessage: message
          })
        });

        const result = await response.json();
        
        removeLoadingMessage();
        
        if (result.success && result.data && result.data.response) {
          addMessage('character', result.data.response, currentCharacter.name);
        } else {
          throw new Error('Failed to get response');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        removeLoadingMessage();
        const responseFailedText = window.errorDisplay.getTranslatedText('characterResponseFailed', '抱歉，我現在無法回應。請稍後再試。');
        addMessage('character', responseFailedText, currentCharacter.name);
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    // Event listeners
    document.getElementById('backToGames').addEventListener('click', () => {
      window.location.href = '/game/game-selection.html';
    });

    document.getElementById('newCharacter').addEventListener('click', generateCharacter);
    
    document.getElementById('sendMessage').addEventListener('click', sendUserMessage);
    
    document.getElementById('userMessage').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
      }
    });

    // Start game
    generateCharacter();
  </script>
</body>
</html>
