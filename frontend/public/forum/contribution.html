<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡åŒ–æ¢ç´¢ â€” è«–å£‡ - æ–‡åŒ–åˆ†äº«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: {
              300: '#ffd700',
              400: '#ffed4e',
              600: '#daa520',
              700: '#b8860b'
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/assets/gold-theme.css">
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/i18n.js"></script>
  <script src="/assets/auth.js"></script>
  <script src="/assets/auth-modal.js"></script>
  <script src="/assets/login-prompt.js"></script>
  <script src="/assets/api-helper.js"></script>
  <script src="/assets/error-display.js"></script>
  <script src="/assets/load-header.js"></script>
  <script src="/assets/localization-helper.js"></script>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- Header placeholder -->
  <header></header>

  <main class="container mx-auto p-6">
    <div class="flex items-center mb-8">
      <button id="backToForum" class="mr-4 p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <h2 class="text-title-lg font-bold text-gold-300" data-i18n="contributionTab">æ–‡åŒ–åˆ†äº«</h2>
    </div>

    <!-- Contribution Content -->
    <div class="space-y-4">
      <div class="bg-gray-900 bg-opacity-80 p-6 rounded-xl border border-gray-700">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-title font-bold text-gold-300" data-i18n="culturalResources">æ–‡åŒ–è³‡æºåˆ†äº«</h3>
          <button id="uploadCultureBtn" class="px-4 py-2 bg-gold-600 hover:bg-gold-700 text-black font-semibold rounded-lg transition-colors text-body-sm" data-i18n="uploadResource">
            ä¸Šå‚³æ–‡åŒ–è³‡æº
          </button>
        </div>

        <!-- Upload Form Container (initially hidden) -->
        <div id="uploadFormContainer" class="hidden mb-6">
          <iframe id="uploadFormFrame" src="" style="width: 100%; border: none; background: transparent;" onload="adjustIframeHeight(this)"></iframe>
        </div>

        <!-- Shared Resources -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sharedResourcesGrid">
          <!-- Resource cards will be rendered here by JavaScript -->
        </div>
        
        <!-- Detail View Container (initially hidden) -->
        <div id="detailViewContainer" class="hidden mt-4 mb-6 col-span-full">
          <!-- Detail content will be loaded here -->
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentPage = 1;
    let totalPages = 1;
    const ITEMS_PER_PAGE = 12;
    let activeDetailCard = null; // Track which card's detail is open

    // Toggle upload form
    function toggleUploadForm() {
      const container = document.getElementById('uploadFormContainer');
      const iframe = document.getElementById('uploadFormFrame');
      const detailContainer = document.getElementById('detailViewContainer');

      // Close detail view if open
      if (!detailContainer.classList.contains('hidden')) {
        detailContainer.classList.add('hidden');
        activeDetailCard = null;
      }

      if (container.classList.contains('hidden')) {
        iframe.src = '/forum/upload-form.html';
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
        iframe.src = '';
      }
    }

    // Hide upload form (called from iframe)
    function hideUploadForm() {
      const container = document.getElementById('uploadFormContainer');
      container.classList.add('hidden');
      container.querySelector('iframe').src = '';
    }

    // Adjust iframe height to fit content
    function adjustIframeHeight(iframe) {
      try {
        iframe.style.height = (iframe.contentDocument.body.scrollHeight + 20) + 'px';
      } catch (e) {
        iframe.style.height = '600px'; // Fallback
      }
    }

    // Fetch shares from server API
    async function fetchShares(page = 1) {
      try {
        const response = await apiHelper.request(
          `/api/forum/shares?page=${page}&limit=${ITEMS_PER_PAGE}&sort=-created_at`,
          { method: 'GET' }
        );
        if (!response.ok) throw new Error(`API error: ${response.status}`);
        
        const result = await response.json();
        if (result.success) {
          renderResourceCards(result.data);
        } else {
          showError(result.message || 'Failed to fetch shares');
        }
      } catch (error) {
        console.error('[Contribution] Error fetching shares:', error);
        showError('Failed to load cultural resources');
      }
    }

    // Transform resource data with localized text
    function transformResourceToCard(resource) {
      const safeGetLocalizedText = (i18nField, fallback) => {
        try {
          const parsed = typeof i18nField === 'string' ? JSON.parse(i18nField) : i18nField;
          return getLocalizedText(parsed, fallback);
        } catch (e) {
          return getLocalizedText(i18nField, fallback);
        }
      };

      return {
        id: resource.id,
        emoji: resource.icon || 'ğŸ“š',
        title: safeGetLocalizedText(resource.title_i18n, resource.title),
        description: safeGetLocalizedText(resource.description_i18n, resource.description),
        tags: resource.tags || [],
        tagNames: (resource.tags || []).map(tag => safeGetLocalizedText(tag.name_i18n, tag.name)),
        authorName: resource.author_name || 'Anonymous',
        viewCount: resource.view_count || 0,
        likeCount: resource.like_count || 0,
        files: resource.files || [],
      };
    }

    // Store all resources globally for re-rendering
    let allResources = [];

    // Render resource cards
    function renderResourceCards(resources) {
      const container = document.getElementById('sharedResourcesGrid');
      
      // Store resources globally
      allResources = resources;
      
      // Clear only the cards, keep detailViewContainer
      const cards = container.querySelectorAll('[data-resource-id]');
      cards.forEach(card => card.remove());

      if (!resources || resources.length === 0) {
        const noDataMsg = document.createElement('p');
        noDataMsg.className = 'text-gray-400 col-span-full text-center py-8';
        noDataMsg.setAttribute('data-i18n', 'noResources');
        noDataMsg.textContent = 'æš«ç„¡æ–‡åŒ–è³‡æºåˆ†äº«';
        container.insertBefore(noDataMsg, container.firstChild);
        return;
      }

      // Create document fragment for better performance
      const fragment = document.createDocumentFragment();

      resources.forEach(rawResource => {
        const resource = transformResourceToCard(rawResource);
        const card = document.createElement('div');
        card.className = 'bg-gray-800 p-4 rounded-lg border border-gray-600 hover:border-gold-600 transition-colors cursor-pointer flex flex-col h-full';
        card.dataset.resourceId = resource.id;

        card.innerHTML = `
          <div class="aspect-video bg-gray-700 rounded-lg mb-3 flex items-center justify-center"><span class="text-4xl">${resource.emoji}</span></div>
          <h4 class="font-semibold text-white mb-2 text-body line-clamp-2">${resource.title}</h4>
          <p class="text-body-sm text-gray-400 mb-3 line-clamp-2 flex-grow">${resource.description}</p>
          <div class="flex flex-wrap gap-2 mb-3">${resource.tagNames.map(t => `<span class="text-xs bg-gold-700 text-black px-2 py-1 rounded">${t}</span>`).join('')}</div>
          <div class="flex justify-between items-center text-body-sm text-gray-400 pt-3 border-t border-gray-700">
            <span>ğŸ‘¤ ${resource.authorName}</span>
            <div class="flex gap-3"><span>ğŸ‘ï¸ ${resource.viewCount}</span><span>â¤ï¸ ${resource.likeCount}</span></div>
          </div>
        `;

        // Store the full resource data on the card element
        card._resourceData = resource;
        card.addEventListener('click', () => showDetailView(card, resource));
        fragment.appendChild(card);
      });

      // Insert all cards at the beginning (before detailViewContainer if it exists)
      container.insertBefore(fragment, container.firstChild);
    }

    // Show inline detail view
    async function showDetailView(cardElement, resource) {
      const detailContainer = document.getElementById('detailViewContainer');
      const grid = document.getElementById('sharedResourcesGrid');
      
      console.log('[DetailView] Showing detail for:', resource.title, 'Resource:', resource);
      
      // If clicking the same card that's already open, close it.
      if (activeDetailCard === cardElement && !detailContainer.classList.contains('hidden')) {
        console.log('[DetailView] Closing same card');
        detailContainer.classList.add('hidden');
        detailContainer.innerHTML = '';
        activeDetailCard = null;
        return;
      }
      
      // Always clear the hidden class to make sure it's visible
      detailContainer.classList.remove('hidden');

      // Close upload form if open
      const uploadContainer = document.getElementById('uploadFormContainer');
      if (!uploadContainer.classList.contains('hidden')) {
        console.log('[DetailView] Closing upload form');
        uploadContainer.classList.add('hidden');
        uploadContainer.querySelector('iframe').src = '';
      }

      activeDetailCard = cardElement;
      detailContainer.innerHTML = '<p class="text-center text-gray-400 p-8">Loading details...</p>';
      
      // Calculate where to insert the detail view
      const itemsPerRow = window.innerWidth >= 1024 ? 3 : (window.innerWidth >= 768 ? 2 : 1);
      const cardIndex = Array.from(grid.children).filter(child => !child.id).indexOf(cardElement);
      const endOfRowIndex = Math.floor(cardIndex / itemsPerRow) * itemsPerRow + itemsPerRow;
      
      // Find the reference node (skip detailViewContainer itself)
      let refNode = null;
      let count = 0;
      for (let child of grid.children) {
        if (child.id !== 'detailViewContainer') {
          if (count === endOfRowIndex) {
            refNode = child;
            break;
          }
          count++;
        }
      }

      // Move the container and make it visible
      if (refNode) {
        grid.insertBefore(detailContainer, refNode);
      } else {
        grid.appendChild(detailContainer);
      }
      detailContainer.className = 'mt-4 mb-6 col-span-full bg-gray-800 rounded-lg border border-gold-600 shadow-xl';

      try {
        const response = await fetch('/forum/detail.html');
        if (!response.ok) throw new Error('Failed to load detail template');
        
        const template = await response.text();
        detailContainer.innerHTML = template;

        // Apply i18n translations IMMEDIATELY after loading template
        if (window.i18next) {
          detailContainer.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (key) {
              const translation = window.i18next.t(key);
              if (translation && translation !== key) {
                element.textContent = translation;
              }
            }
          });
        }

        // Populate template with resource data
        detailContainer.querySelector('#name').textContent = resource.title;
        detailContainer.querySelector('#author-name').textContent = resource.authorName;
        detailContainer.querySelector('#view-count').textContent = resource.viewCount;
        detailContainer.querySelector('#like-count').textContent = resource.likeCount;
        detailContainer.querySelector('#description').innerHTML = `<p>${resource.description}</p>`;
        
        // Populate tags
        const tagsContainer = detailContainer.querySelector('#tags-container');
        if (resource.tagNames && resource.tagNames.length > 0) {
          tagsContainer.innerHTML = resource.tagNames
            .map(tagName => `<span class="text-xs bg-gold-700 text-black px-3 py-1 rounded-full">${tagName}</span>`)
            .join('');
        } else {
          detailContainer.querySelector('#tags-section').style.display = 'none';
        }
        
        // Populate file list
        const fileList = detailContainer.querySelector('#file-list');
        fileList.innerHTML = '';
        if (resource.files && resource.files.length > 0) {
          resource.files.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center gap-3 p-3 bg-gray-700 rounded-lg hover:bg-gray-600 cursor-pointer transition-colors';
            fileItem.innerHTML = `
              <svg class="w-5 h-5 text-gold-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
              <span class="text-white text-body flex-1">${file.name}</span>
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            `;
            fileItem.onclick = () => {
              // TODO: Implement file viewer
              alert(`æŸ¥çœ‹æ–‡ä»¶: ${file.name}`);
            };
            fileList.appendChild(fileItem);
          });
        } else {
          const noFilesMsg = document.createElement('p');
          noFilesMsg.className = 'text-gray-500 text-body-sm p-4 text-center';
          noFilesMsg.setAttribute('data-i18n', 'noFiles');
          noFilesMsg.textContent = window.i18next ? window.i18next.t('noFiles') : 'æš«ç„¡æª”æ¡ˆ';
          fileList.appendChild(noFilesMsg);
        }

        // Setup action buttons
        detailContainer.querySelector('#download-btn').onclick = () => {
          // TODO: Implement ZIP download
          const msg = window.i18next ? window.i18next.t('featureDevelopment') : 'åŠŸèƒ½é–‹ç™¼ä¸­';
          alert(msg + '...');
        };
        
        detailContainer.querySelector('#play-btn').onclick = () => {
          // å‚è€ƒ culture-selection.html çš„å­˜å‚¨æ­¥éª¤
          localStorage.setItem('selectedShareId', resource.id);
          localStorage.setItem('selectedTheme', resource.title);
          localStorage.setItem('selectedDescription', resource.description);
          // è·³è½¬åˆ°æ¸¸æˆé€‰æ‹©é¡µé¢ï¼Œä¼ é€’ shareId å‚æ•°
          window.location.href = `/game/game-selection.html?shareId=${resource.id}`;
        };

        detailContainer.querySelector('#close-detail-btn').onclick = () => {
          detailContainer.classList.add('hidden');
          detailContainer.innerHTML = '';
          activeDetailCard = null;
        };

        // Final i18n update (in case any dynamic content was added)
        if (window.i18next && typeof updateUI === 'function') {
          updateUI(window.i18next.language);
        }

      } catch (error) {
        console.error('[DetailView] Error loading detail view:', error);
        detailContainer.innerHTML = `<div class="p-8 text-center"><p class="text-red-500 text-body">è¼‰å…¥å¤±æ•—: ${error.message}</p></div>`;
      }
    }

    // Event listeners
    document.getElementById('backToForum').addEventListener('click', () => {
      window.location.href = '/forum/forum.html';
    });

    document.getElementById('uploadCultureBtn').addEventListener('click', () => {
      console.log('[Upload Button] Clicked');
      console.log('[Upload Button] apiHelper:', window.apiHelper);
      
      // Check if user is logged in
      const token = window.apiHelper ? window.apiHelper.getAuthToken() : null;
      console.log('[Upload Button] Token:', token ? 'exists' : 'null');
      
      if (!token) {
        console.log('[Upload Button] No token, showing login prompt');
        if (window.showLoginPrompt) {
          window.showLoginPrompt();
        } else if (window.openAuthModal) {
          window.openAuthModal('login');
        } else {
          alert('è«‹å…ˆç™»å…¥ä»¥ä¸Šå‚³è³‡æº');
        }
        return;
      }
      
      console.log('[Upload Button] Token exists, toggling form');
      toggleUploadForm();
    });

    // Initialize page
    async function initPage() {
      console.log('[Contribution] initPage called');
      
      // Store current scroll position
      const scrollY = window.scrollY;
      
      // Store current open detail state before re-rendering
      const wasDetailOpen = activeDetailCard !== null && !document.getElementById('detailViewContainer').classList.contains('hidden');
      const openResourceId = wasDetailOpen ? activeDetailCard.dataset.resourceId : null;
      
      console.log('[Contribution] Detail was open:', wasDetailOpen, 'Resource ID:', openResourceId);
      
      await fetchShares(1);
      
      // Restore scroll position immediately
      window.scrollTo(0, scrollY);
      
      // Restore open detail if it was open before
      if (wasDetailOpen && openResourceId) {
        console.log('[Contribution] Attempting to restore detail view for:', openResourceId);
        setTimeout(() => {
          const card = document.querySelector(`[data-resource-id="${openResourceId}"]`);
          console.log('[Contribution] Found card to restore:', card);
          if (card && card._resourceData) {
            console.log('[Contribution] Restoring detail with data:', card._resourceData);
            showDetailView(card, card._resourceData);
            // Restore scroll position again after detail view is shown
            setTimeout(() => window.scrollTo(0, scrollY), 50);
          } else if (card) {
            console.log('[Contribution] Card found but no data, clicking card');
            card.click();
            setTimeout(() => window.scrollTo(0, scrollY), 50);
          } else {
            console.warn('[Contribution] Could not find card with ID:', openResourceId);
          }
        }, 150);
      }
      
      if (window.i18next && typeof updateUI === 'function') {
        updateUI(window.i18next.language);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initPage, 100); // Defer to ensure all scripts are ready
    });

    window.addEventListener('i18n:languageChanged', async () => {
      console.log('[Contribution] Language changed, re-initializing page');
      await initPage();
    });
  </script>
</body>
</html>

